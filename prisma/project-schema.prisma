generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/project-client"
}

datasource db {
  provider = "postgresql"
  url      = env("PROJECT_DATABASE_URL")
}

model AstroUser {
  id                String    @id // 直接使用認證系統的用戶ID作為主鍵
  birthDate         DateTime  @map("birth_date") @db.Date
  birthTime         DateTime? @map("birth_time") @db.Time
  birthLocation     String    @map("birth_location")
  latitude          Decimal?  @db.Decimal(10, 8)
  longitude         Decimal?  @db.Decimal(11, 8)
  timezone          String?
  todayDivination   Json?     @map("today_divination")
  divinationDate    DateTime? @map("divination_date") @db.Date
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  chatSessions      ChatSession[]

  @@index([divinationDate])
  @@map("astro_users")
}

model ChatSession {
  id              String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId       String      @unique @map("session_id")
  userId          String      @map("user_id")
  title           String      @db.VarChar(500)
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  user            AstroUser   @relation(fields: [userId], references: [id])
  messages        ChatMessage[]

  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
  @@map("chat_sessions")
}

model ChatMessage {
  id              String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId       String      @map("session_id")
  role            Role
  messageType     MessageType @map("message_type")
  content         String

  // 工具相關欄位
  toolId          String?     @map("tool_id")
  toolName        String?     @map("tool_name")
  toolArgs        Json?       @map("tool_args")
  toolResult      String?     @map("tool_result")

  // 文本訊息相關欄位
  sources         Json?
  prompts         Json?

  // 評分及優化欄位
  score           Int?        @db.SmallInt
  note            String?

  // 訊息順序
  messageOrder    Int         @map("message_order")
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  session         ChatSession @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
  @@index([sessionId, messageOrder])
  @@map("chat_messages")
}

enum Role {
  human
  ai
}

enum MessageType {
  text
  tool_use @map("tool_use")
  tool_result @map("tool_result")
  choose_agent @map("choose_agent")
}
